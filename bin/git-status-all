#!/usr/bin/env bash
# shellcheck disable=SC2164

DIR="$HOME/Code/github/"
if [[ -n $1 ]]; then
  DIR="$1"
fi

for dir in $(find "$DIR" -maxdepth 2 -name ".git" 2>/dev/null | sed 's/.git$//g'); do
  (
    cd "$dir"
    curr_branch=$(git rev-parse --abbrev-ref HEAD)
    curr_remote=$(git config branch."$curr_branch".remote)
    curr_merge_branch=$(git config branch."$curr_branch".merge | cut -d / -f 3)

    if [[ -z $curr_remote ]]; then
      printf "\n%s\nhas no remote\n" "$dir"
      git status -sb
    elif [[ -n $(git status --porcelain) && "$ahead_behind" != "0|0" ]]; then
      ahead_behind=$(git rev-list --left-right --count "$curr_branch"..."$curr_remote"/"$curr_merge_branch" | tr -s '\t' '|')
      printf "\n%s\n" "$dir"
      printf "ahead/behind:  %s\n" "$ahead_behind"
      git status -sb
    fi
  )
done


